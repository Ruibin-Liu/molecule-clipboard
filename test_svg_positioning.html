<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Debug SVG Positioning</title>
</head>
<body>
  <h1>Debug SVG Positioning</h1>
  <p>Check where the name is actually positioned and the SVG bounds</p>

  <button onclick="testSVG()">Test Aspirin</button>
  <br><br>

  <div id="svgContainer"></div>
  <br><br>
  <div id="debugInfo" style="background: #f5f5f5; padding: 20px; border: 1px solid #ccc;"></div>

  <script src="https://cdn.jsdelivr.net/npm/@rdkit/rdkit/dist/RDKit_minimal.js"></script>
  <script>
    let rdkit = null;

    async function init() {
      rdkit = await initRDKitModule();
      document.getElementById("debugInfo").textContent = "RDKit loaded successfully!\n\nClick button to test.";
    }

    function testSVG() {
      const smiles = "O=C(C)Oc1ccccc1C(=O)O"; // Aspirin
      const name = "Aspirin";
      const mol = rdkit.get_mol(smiles);
      if (!mol || !mol.is_valid()) {
        alert("Unable to parse SMILES");
        return;
      }

      // Get original SVG
      let svgContent = mol.get_svg();

      // First, append the SVG to the DOM to measure elements properly
      document.getElementById("svgContainer").innerHTML = svgContent;

      // Now measure the elements after they're rendered
      setTimeout(() => {
        const svgElement = document.querySelector("#svgContainer svg");

        let debugInfo = "";
        debugInfo += "Original SVG Analysis:\n";
        debugInfo += "=".repeat(50) + "\n\n";

        if (svgElement) {
          const viewBox = svgElement.getAttribute('viewBox');
          let width = svgElement.getAttribute('width');
          let height = svgElement.getAttribute('height');

          if (viewBox) {
            const parts = viewBox.split(/\s+/).map(parseFloat);
            width = parts[2] - parts[0];
            height = parts[3] - parts[1];
            debugInfo += `viewBox: ${viewBox}\n`;
            debugInfo += `Calculated width: ${width}\n`;
            debugInfo += `Calculated height: ${height}\n`;

            // Extend viewBox height to make room for text
            svgElement.setAttribute('viewBox', `0 0 ${width} ${height + 40}`);
            debugInfo += `Extended viewBox: 0 0 ${width} ${height + 40}\n`;
            height = height + 40;
          } else if (width && height) {
            width = parseFloat(width);
            height = parseFloat(height);
            debugInfo += `Direct width: ${width}\n`;
            debugInfo += `Direct height: ${height}\n`;
          }

          // Get bounding box of existing elements
          const allElements = svgElement.querySelectorAll('path, circle, rect, line, polygon');
          let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
          allElements.forEach(el => {
            const bbox = el.getBBox();
            if (bbox.x < minX) minX = bbox.x;
            if (bbox.y < minY) minY = bbox.y;
            if (bbox.x + bbox.width > maxX) maxX = bbox.x + bbox.width;
            if (bbox.y + bbox.height > maxY) maxY = bbox.y + bbox.height;
          });

          debugInfo += `\nElement BBox:\n`;
          debugInfo += `  minX: ${minX.toFixed(2)}, minY: ${minY.toFixed(2)}\n`;
          debugInfo += `  maxX: ${maxX.toFixed(2)}, maxY: ${maxY.toFixed(2)}\n`;
          debugInfo += `  contentWidth: ${(maxX - minX).toFixed(2)}\n`;
          debugInfo += `  contentHeight: ${(maxY - minY).toFixed(2)}\n`;

          // Add name text
          const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
          const yPos = maxY + 25;
          text.setAttribute('x', (minX + maxX) / 2);
          text.setAttribute('y', yPos);
          text.setAttribute('text-anchor', 'middle');
          text.setAttribute('font-size', '14');
          text.setAttribute('font-family', 'Arial, sans-serif');
          text.setAttribute('font-weight', 'bold');
          text.setAttribute('fill', '#0f172a');
          text.textContent = name;
          svgElement.appendChild(text);

          debugInfo += `\nName Position:\n`;
          debugInfo += `  x: ${(minX + maxX) / 2}\n`;
          debugInfo += `  y: ${yPos}\n`;
          debugInfo += `  SVG height: ${height}\n`;
          debugInfo += `  Content max Y: ${maxY.toFixed(2)}\n`;
          debugInfo += `  Gap: ${(yPos - maxY).toFixed(2)} pixels\n`;

          document.getElementById("debugInfo").textContent = debugInfo;
        }

        mol.delete();
        }, 100);
     }
 
     init();
   </script>
</body>
</html>
