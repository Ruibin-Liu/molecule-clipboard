<!doctype html>
<html lang="en">
<head>
 <meta charset="utf-8">
 <title>Molecule Clipboard</title>
 <meta name="viewport" content="width=device-width, initial-scale=1">
 <meta name="theme-color" content="#2563eb">
 <meta name="description" content="Molecule Clipboard is a browser-based RDKit tool for inspecting, canonicalizing, and sharing small molecules from SMILES, MOL, or SDF. Runs locally with no uploads.">
 <meta name="keywords" content="RDKit, molecule inspector, SMILES viewer, cheminformatics, chemical structure, molecular properties, browser RDKit">
 <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'>
  <rect width='32' height='32' rx='6' fill='%232563eb'/>
  <circle cx='10' cy='16' r='3' fill='white'/>
  <circle cx='22' cy='10' r='3' fill='white'/>
  <circle cx='22' cy='22' r='3' fill='white'/>
   <line x1='10' y1='16' x2='22' y2='10' stroke='white' stroke-width='2'/>
   <line x1='10' y1='16' x2='22' y2='22' stroke='white' stroke-width='2'/>
</svg>
">

<script defer src="https://cdn.jsdelivr.net/npm/jsme@2017.2.26/jsme/jsme.nocache.js"></script>

<style>
:root {
  --bg: #f8fafc;
  --panel: #ffffff;
  --border: #e2e8f0;
  --text: #0f172a;
  --muted: #64748b;
  --accent: #2563eb;
  --good: #166534;
  --bad: #b91c1c;
}

 * { box-sizing: border-box; }

 body {
   margin: 0;
   background: var(--bg);
   color: var(--text);
   font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
                Roboto, Helvetica, Arial, sans-serif;
 }

 .container {
   max-width: 1100px;
   margin: 2.5rem auto;
   padding: 0 1.5rem;
 }

 header {
   margin-bottom: 1.5rem;
 }

 h1 {
   font-size: 1.5rem;
   margin: 0;
   font-weight: 600;
 }

 .subtitle {
   color: var(--muted);
   margin-top: 0.25rem;
   font-size: 0.95rem;
 }

 .version {
   color: var(--muted);
   margin-top: 0.5rem;
   font-size: 0.8rem;
   font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
 }

 .badges {
   margin-top: 0.75rem;
   display: flex;
   gap: 0.75rem;
   flex-wrap: wrap;
 }

 .badge {
   display: inline-flex;
   align-items: center;
   padding: 0.35rem 0.65rem;
   border-radius: 6px;
   background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
   color: var(--text);
   font-size: 0.75rem;
   font-weight: 500;
   border: 1px solid var(--border);
   box-shadow: 0 1px 2px rgba(0,0,0,0.05);
   text-decoration: none;
   transition: all 0.15s ease;
 }

 .badge:hover {
   transform: translateY(-1px);
   box-shadow: 0 2px 4px rgba(0,0,0,0.1);
   border-color: var(--accent);
 }

 .badge svg {
   width: 13px;
   height: 13px;
   margin-right: 5px;
   border: none;
   background: transparent;
 }

 .result-badge {
   display: inline-block;
   padding: 0.25rem 0.5rem;
   border-radius: 4px;
   font-size: 0.75rem;
   font-weight: 500;
 }

 .result-badge.pass {
   background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
   color: #166534;
 }

 .result-badge.fail {
   background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
   color: #b91c1c;
 }

 .modal {
   display: none;
   position: fixed;
   top: 0;
   left: 0;
   width: 100%;
   height: 100%;
   background: rgba(0,0,0,0.5);
   z-index: 1000;
 }

 .modal-content {
   position: relative;
   width: 90%;
   max-width: 900px;
   max-height: 90%;
   margin: 2rem auto;
   background: #fff;
   border-radius: 10px;
   display: flex;
   flex-direction: column;
 }

 .modal-header {
   display: flex;
   justify-content: space-between;
   align-items: center;
   padding: 1rem 1.5rem;
   border-bottom: 1px solid var(--border);
 }

 .modal-header h2 {
   margin: 0;
   font-size: 1.1rem;
   font-weight: 600;
 }

  .modal-header .close-btn {
     background: none;
     border: none;
     font-size: 1.5rem;
     cursor: pointer;
     padding: 0 0.5rem;
     line-height: 1;
     color: var(--text);
  }

 .modal-header .copy-btn {
    background: var(--accent);
    color: #fff;
    border: none;
    border-radius: 4px;
    padding: 0.25rem 0.6rem;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.15s ease;
  }

 .modal-header .copy-btn:hover {
    background: #1d4ed8;
  }

 .modal-body {
   flex: 1;
   overflow: auto;
   padding: 1.5rem;
 }

 .modal-body pre {
   margin: 0;
   white-space: pre-wrap;
   word-wrap: break-word;
   font-size: 0.8rem;
   font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
 }

.panel {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 1rem;
  margin-top: 1rem;
}

textarea {
  width: 100%;
  min-height: 110px;
  resize: vertical;
  padding: 0.65rem;
  font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
  font-size: 0.9rem;
  border-radius: 8px;
  border: 1px solid var(--border);
}

textarea:focus {
  outline: none;
  border-color: var(--accent);
}

  .controls {
   margin-top: 0.75rem;
   display: grid;
   grid-template-columns: repeat(2, 1fr);
   gap: 0.5rem;
  }

  .controls button {
   display: inline-flex;
   align-items: center;
   gap: 4px;
  }

  .controls button svg {
   width: 14px;
   height: 14px;
  }

 button {
   appearance: none;
   border: 1px solid var(--border);
   background: #fff;
   color: var(--text);
   padding: 0.4rem 0.7rem;
   border-radius: 8px;
   font-size: 0.85rem;
   cursor: pointer;
   width: auto;
 }

 button.primary {
   background: var(--accent);
   color: #fff;
   border-color: var(--accent);
 }

 button:hover {
   background: #f8fafc;
   border-color: var(--accent);
 }

 button:active {
   transform: translateY(1px);
 }

 button:disabled {
   opacity: 0.6;
   cursor: not-allowed;
 }

 button.copied {
   background: #22c55e;
   color: #fff;
   border-color: #22c55e;
 }

  .drop {
   margin-top: 0.75rem;
   border: 1px dashed var(--border);
   border-radius: 8px;
   padding: 0.6rem;
   font-size: 0.8rem;
   color: var(--muted);
   text-align: center;
   margin-bottom: 1rem;
  }

  .separator {
   margin-top: 0.75rem;
   margin-bottom: 0.75rem;
   text-align: center;
   font-size: 0.75rem;
   color: var(--muted);
  }

#error {
  margin-top: 0.75rem;
  color: var(--bad);
  white-space: pre-wrap;
}

.grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1.25rem;
}

@media (max-width: 900px) {
  .grid { grid-template-columns: 1fr; }
}

 #svg svg {
   width: 100%;
   max-width: 100%;
   border: 1px solid var(--border);
   border-radius: 6px;
   background: #fff;
   display: block;
 }

 #svg {
   width: 100%;
 }

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.85rem;
}

td {
  padding: 0.25rem 0.35rem;
  vertical-align: top;
}

td.key {
  color: var(--muted);
  width: 45%;
}

td.value {
  font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
  word-break: break-all;
}

.good { color: var(--good); font-weight: 500; }
.bad  { color: var(--bad);  font-weight: 500; }

details {
  margin-top: 0.75rem;
}

  pre {
    background: #f1f5f9;
    border-radius: 6px;
    padding: 0.5rem;
    overflow-x: auto;
    font-size: 0.8rem;
  }

  .copyright {
    text-align: center;
    padding: 2rem;
    color: var(--muted);
    font-size: 0.8rem;
    margin-top: auto;
  }
  </style>
</head>

<body>
<div class="container">

 <header>
   <h1>Molecule Clipboard</h1>
   <div class="subtitle">
     A browser-based RDKit tool for inspecting and canonicalizing small molecules
   </div>
   <div class="badges">
     <span class="badge" title="Single HTML file - just open in any browser">
       <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
         <circle cx="12" cy="12" r="10"/>
         <path d="M2 12h20"/>
         <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10 15.3 15.3 0 0 1 4-10z"/>
       </svg>
       Runs Anywhere
     </span>
     <span class="badge" title="All processing happens in your browser - no data sent anywhere">
       <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
         <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
         <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
       </svg>
       Runs Locally
     </span>
     <span class="badge" onclick="viewSource()" title="View HTML source">
       <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
         <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
       </svg>
       View Source
     </span>
   </div>
   <div class="version">RDKit version: <span id="rdkitVersion">Loading...</span></div>
 </header>

<div class="panel">
  <textarea id="input" placeholder="Paste SMILES, MolBlock, or SDF here"></textarea>

  <div class="separator">-- or --</div>

  <div class="drop" id="drop">
    Drag & drop MOL / SDF / TXT files here
  </div>

   <div style="display: flex; gap: 0.5rem;">
     <button onclick="openJSME()" style="color: #2563eb; border-color: #2563eb;">Draw/Edit</button>
     <button onclick="clearAll()" style="color: #b91c1c; border-color: #b91c1c;">Clear</button>
   </div>

  <div id="error"></div>
</div>

<div id="output" style="display:none">

   <div class="panel grid">
     <div>
         <strong>Structure</strong>
         <div id="svg" style="margin-top:0.75rem; margin-bottom:0.75rem;"></div>
         <div class="controls">
           <button onclick="downloadSVG()">
             <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
               <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
               <polyline points="7,10 12,15 17,10"/>
               <line x1="12" y1="15" x2="12" y2="3"/>
             </svg>
             Download SVG
           </button>
           <button onclick="downloadPNG()">
             <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
               <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
               <polyline points="7,10 12,15 17,10"/>
               <line x1="12" y1="15" x2="12" y2="3"/>
             </svg>
             Download PNG
           </button>
           <button onclick="copySVG()">
             <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
               <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
               <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
             </svg>
             Copy SVG
           </button>
           <button onclick="copyShareLink()">
             <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
               <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
               <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
             </svg>
             Share link
           </button>
         </div>
       </div>

     <div>
       <strong>Properties</strong>
       <table id="props"></table>

       <br>
       <strong>Rules</strong>
       <table id="rules"></table>
     </div>
  </div>

  <div class="panel">
    <strong>Representations</strong>
    <table>
      <tr>
        <td class="key">Canonical SMILES</td>
        <td class="value" id="smiles"></td>
        <td><button onclick="copy('smiles')">Copy</button></td>
      </tr>
      <tr>
        <td class="key">InChI</td>
        <td class="value" id="inchi"></td>
        <td><button onclick="copy('inchi')">Copy</button></td>
      </tr>
      <tr>
        <td class="key">InChIKey</td>
        <td class="value" id="inchikey"></td>
        <td><button onclick="copy('inchikey')">Copy</button></td>
      </tr>
    </table>

     <details>
       <summary>MolBlock</summary>
       <pre id="molblock"></pre>
       <button onclick="copy('molblock')">Copy MolBlock</button>
       <button onclick="downloadSDF()">Download SDF</button>
      </details>
   </div>
 </div>

  <div class="copyright">
   © <span id="year"></span> <a href="https://github.com/Ruibin-Liu/molecule-clipboard" target="_blank" rel="noopener">Ruibin-Liu</a>
 </div>

<script>
let rdkitModule = null;

  async function initRDKit() {
    try {
      rdkitModule = await initRDKitModule();
      displayVersion();
      loadFromURL();
      setupAutoProcess();
    } catch(e) {
      document.getElementById("error").textContent = "Failed to load RDKit: " + e;
    }
  }

  let debounceTimer;
  function setupAutoProcess() {
    const input = document.getElementById("input");
    input.addEventListener("input", () => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        process(true);
      }, 500);
    });
  }
</script>
<script src="https://cdn.jsdelivr.net/npm/@rdkit/rdkit/dist/RDKit_minimal.js"></script>
<script>initRDKit();</script>

<script>
 let mol = null;

 function process(updateURL = true) {
   clearError();
   try {
     let input = document.getElementById("input").value;
     if (!input.trim()) throw "Empty input";

     if (mol) mol.delete();
     mol = rdkitModule.get_mol(input);
     if (!mol || !mol.is_valid()) throw "Unable to parse molecule";

     const smiles = mol.get_smiles();
     mol.delete();

     mol = rdkitModule.get_mol(smiles);
     if (!mol || !mol.is_valid()) throw "Unable to generate 2D structure";

      render(mol);
      if (updateURL) setURL(smiles);
   } catch (e) {
     showError(e);
   }
 }

 function displayVersion() {
   document.getElementById("rdkitVersion").textContent = rdkitModule.version();
 }

 function render(m) {
   document.getElementById("output").style.display = "block";
   document.getElementById("svg").innerHTML = m.get_svg();

   document.getElementById("smiles").textContent   = m.get_smiles();
   const inchi = m.get_inchi();
   document.getElementById("inchi").textContent = inchi;
   document.getElementById("inchikey").textContent = rdkitModule.get_inchikey_for_inchi(inchi);
   document.getElementById("molblock").textContent = m.get_molblock();

   const d = JSON.parse(m.get_descriptors());

   const props = [
     ["MW",    d.amw.toFixed(2)],
     ["cLogP", d.CrippenClogP.toFixed(2)],
     ["TPSA",  d.tpsa.toFixed(2)],
     ["HBD",   d.NumHBD],
     ["HBA",   d.NumHBA],
     ["RotB",  d.NumRotatableBonds]
   ];

   document.getElementById("props").innerHTML = "";
   props.forEach(([k, v]) => {
     document.getElementById("props").insertAdjacentHTML(
       "beforeend",
       `<tr><td class="key">${k}</td><td class="value">${v}</td></tr>`
     );
   });

   const lipinski =
     d.amw <= 500 &&
     d.CrippenClogP <= 5 &&
     d.NumHBD <= 5 &&
     d.NumHBA <= 10;

   const veber =
     d.tpsa <= 140 &&
     d.NumRotatableBonds <= 10;

    document.getElementById("rules").innerHTML = `
      <tr><td class="key">Lipinski</td><td class="value"><span class="result-badge ${lipinski?'pass':'fail'}">${lipinski?'Pass':'Fail'}</span></td></tr>
      <tr><td class="key">Veber</td><td class="value"><span class="result-badge ${veber?'pass':'fail'}">${veber?'Pass':'Fail'}</span></td></tr>
    `;
 }

  function copy(id) {
    const text = document.getElementById(id).textContent;
    navigator.clipboard.writeText(text);

    const button = document.querySelector(`button[onclick="copy('${id}')"]`);
    if (button) {
      const originalText = button.textContent;
      button.classList.add('copied');
      button.textContent = 'Copied!';
      setTimeout(() => {
        button.textContent = originalText;
        button.classList.remove('copied');
      }, 1500);
    }
  }

  function downloadSDF() {
    const molblock = document.getElementById("molblock").textContent;
    const sdf = molblock + "$$$$";
    const a = document.createElement("a");
    a.href = URL.createObjectURL(new Blob([sdf], {type:"chemical/x-mdl-molfile"}));
    a.download = "molecule.sdf";
    a.click();
  }

function setURL(smiles) {
  location.hash = "mol=" + btoa(smiles);
}

 function loadFromURL() {
   if (!location.hash.startsWith("#mol=")) return;
   document.getElementById("input").value = atob(location.hash.slice(5));
   process(false);
 }

 function copyShareLink() {
    navigator.clipboard.writeText(location.href);

    const btn = document.querySelector("button[onclick='copyShareLink()']");
    const originalText = btn.textContent;
    btn.classList.add('copied');
    btn.textContent = 'Copied!';
    setTimeout(() => {
      btn.textContent = originalText;
      btn.classList.remove('copied');
    }, 1500);
  }

 function downloadSVG() {
    const s = document.querySelector("#svg svg");
    const svgContent = addSVGWrapper(s.outerHTML);

    const a = document.createElement("a");
    a.href = URL.createObjectURL(new Blob([svgContent], {type:"image/svg+xml"}));
    a.download = "molecule.svg";
    a.click();
  }

  const PNG_EXPORT_PRESET = {
    baseSize: 300,
    pngSize: 1200,
    strokeWidth: 2.0,
    fontSize: 15,
    fontFamily: 'Arial, Helvetica, sans-serif',
    strokeColor: '#000000',
    backgroundColor: '#ffffff',
    lineCap: 'round',
    lineJoin: 'round'
  };

  function downloadPNG() {
    const svgEl = document.querySelector("#svg svg");
    if (!svgEl) {
      alert("No structure rendered.");
      return;
    }

    let svgContent = svgEl.outerHTML;

    const processPath = (match) => {
      const hasAtom = match.includes('class="') && match.match(/class="[^"]*atom/);
      const hasBond = match.includes('class="') && match.match(/class="[^"]*bond/);

      if (!hasAtom && !hasBond) return match;

      let result = match;

      if (hasAtom) {
        result = result.replace(/\sfill="[^"]*"/g, '');
        result = result.replace(/fill:\s*#[0-9a-fA-F]+;?/gi, 'fill:#000000;');
        result = result.replace(/fill:\s*rgb\([^)]+\);?/gi, 'fill:#000000;');
      }

      if (hasBond) {
        result = result.replace(/\sstroke="[^"]*"/g, '');
        result = result.replace(/stroke:\s*#[0-9a-fA-F]+;?/gi, 'stroke:#000000;');
        result = result.replace(/stroke:\s*rgb\([^)]+\);?/gi, 'stroke:#000000;');
      }

      return result;
    };

    svgContent = svgContent.replace(/<path[^>]*>/g, processPath);

    svgContent = svgContent.replace(/width="[^"]*"/, `width="${PNG_EXPORT_PRESET.pngSize}"`);
    svgContent = svgContent.replace(/height="[^"]*"/, `height="${PNG_EXPORT_PRESET.pngSize}"`);
    svgContent = svgContent.replace(/viewBox="[^"]*"/, `viewBox="0 0 ${PNG_EXPORT_PRESET.baseSize} ${PNG_EXPORT_PRESET.baseSize}"`);

    const blob = new Blob([svgContent], { type: "image/svg+xml;charset=utf-8" });
    const url = URL.createObjectURL(blob);

    const img = new Image();
    img.src = url;

    img.onload = () => {
      const canvas = document.createElement("canvas");
      canvas.width = PNG_EXPORT_PRESET.pngSize;
      canvas.height = PNG_EXPORT_PRESET.pngSize;

      const ctx = canvas.getContext("2d");
      ctx.fillStyle = PNG_EXPORT_PRESET.backgroundColor;
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

      URL.revokeObjectURL(url);

      const a = document.createElement("a");
      a.href = canvas.toDataURL("image/png");
      a.download = "molecule.png";
      a.click();
    };

    img.onerror = () => {
      showError("Failed to render SVG as PNG");
      URL.revokeObjectURL(url);
    };
  }

 function copySVG() {
   const s = document.querySelector("#svg svg");
   navigator.clipboard.writeText(addSVGWrapper(s.outerHTML));

   const btn = document.querySelector("button[onclick='copySVG()']");
   const originalText = btn.textContent;
   btn.classList.add('copied');
   btn.textContent = 'Copied!';
   setTimeout(() => {
     btn.textContent = originalText;
     btn.classList.remove('copied');
   }, 1500);
 }

 function addSVGWrapper(svgContent) {
   if (!svgContent.includes('xmlns=')) {
     return svgContent.replace('<svg', '<svg xmlns="http://www.w3.org/2000/svg"');
   }
   return svgContent;
 }

   function clearAll() {
      history.replaceState(null, "", location.pathname);
      window.location.reload();
    }

   function viewSource() {
     document.getElementById("sourceCode").textContent = document.documentElement.outerHTML;
     document.getElementById("sourceModal").style.display = "block";
   }

    function closeSourceModal() {
      document.getElementById("sourceModal").style.display = "none";
    }

    function copySource() {
      navigator.clipboard.writeText(document.documentElement.outerHTML);
      const btn = document.querySelector(".copy-btn");
      const originalText = btn.textContent;
      btn.textContent = "Copied!";
      setTimeout(() => btn.textContent = originalText, 1500);
    }

   function showError(e) {
   document.getElementById("error").textContent = e.toString();
 }
  function clearError() {
    document.getElementById("error").textContent = "";
  }

  const drop = document.getElementById("drop");
  drop.ondragover = e => { e.preventDefault(); drop.style.borderColor = "var(--accent)"; };
  drop.ondragleave = () => drop.style.borderColor = "var(--border)";
  drop.ondrop = e => {
    e.preventDefault();
    drop.style.borderColor = "var(--border)";
    const f = e.dataTransfer.files[0];
    if (!f) return;
    const r = new FileReader();
    r.onload = () => { document.getElementById("input").value = r.result; process(); };
     r.readAsText(f);
   };

  let jsmeInstance = null;
  let jsmeModalOpen = false;
  let moleculeToLoad = null;
  let jsmeInitialized = false;

  function createJSME() {
    if (jsmeInitialized) return;

    if (typeof JSApplet !== 'undefined') {
      jsmeInstance = new JSApplet.JSME("jsme_container", "100%", "100%", {
        "options": "star,query"
      });
      jsmeInitialized = true;

      if (jsmeModalOpen && moleculeToLoad) {
        setTimeout(() => {
          if (jsmeInstance && moleculeToLoad) {
            jsmeInstance.readGenericMolecularInput(moleculeToLoad);
            setTimeout(() => {
              if (jsmeInstance) {
                jsmeInstance.deferredRepaint();
              }
            }, 200);
          }
        }, 300);
      }
    }
  }

  function openJSME() {
    document.getElementById("jsmeModal").style.display = "block";
    jsmeModalOpen = true;

    const currentInput = document.getElementById("input").value;
    moleculeToLoad = currentInput.trim();

    if (moleculeToLoad && mol && mol.is_valid()) {
      moleculeToLoad = mol.get_smiles();
    }

    if (!jsmeInitialized) {
      const checkJSME = setInterval(() => {
        if (typeof JSApplet !== 'undefined') {
          clearInterval(checkJSME);
          setTimeout(() => {
            createJSME();
          }, 200);
        }
      }, 100);
      return;
    }

    if (jsmeInstance && moleculeToLoad) {
      setTimeout(() => {
        jsmeInstance.readGenericMolecularInput(moleculeToLoad);
        setTimeout(() => {
          jsmeInstance.deferredRepaint();
        }, 100);
      }, 200);
    }
  }

  function closeJSME() {
    document.getElementById("jsmeModal").style.display = "none";
    jsmeModalOpen = false;
    moleculeToLoad = null;
  }

  function applyJSME() {
    if (jsmeInstance) {
      const smiles = jsmeInstance.smiles();
      if (smiles && smiles.trim()) {
        document.getElementById("input").value = smiles;
        process();
      }
    }
    closeJSME();
  }
  </script>

<script>
  document.getElementById("year").textContent = "2025-" + new Date().getFullYear();
</script>

<div id="sourceModal" class="modal" onclick="if(event.target === this) closeSourceModal()">
  <div class="modal-content">
    <div class="modal-header">
      <h2>HTML Source</h2>
      <div>
        <button class="copy-btn" onclick="copySource()">Copy</button>
        <button class="close-btn" onclick="closeSourceModal()">×</button>
      </div>
    </div>
    <div class="modal-body">
      <pre id="sourceCode"></pre>
    </div>
  </div>
</div>

<div id="jsmeModal" class="modal">
  <div class="modal-content" style="max-width: 1000px; height: 600px; display: flex; flex-direction: column;">
    <div class="modal-header">
      <h2>JSME Editor</h2>
      <div style="display: flex; gap: 0.5rem; align-items: center;">
        <button onclick="closeJSME()">Cancel</button>
        <button class="primary" onclick="applyJSME()">Apply Edits</button>
        <button class="close-btn" onclick="closeJSME()">×</button>
      </div>
    </div>
    <div class="modal-body" style="padding: 0; overflow: hidden; display: flex; flex-direction: column; flex: 1;">
      <div id="jsme_container" style="width: 100%; height: 100%; flex: 1;"></div>
    </div>
  </div>
</div>

 </body>
 </html>
